name: Build Docker-image iroha-builder

on:
  push:
    branches: [ main, support/1.2.x ]
  pull_request:
    branches: [ main, support/1.2.x ]

# strategy:
#   matrix:
#     cpp: [ g++-9, g++-10, clang++ ]
#     os: [ ubuntu-latest, ubuntu-18.04, ubuntu-16.04 ]
#     debrel: [ Debug ]
#     USE_LIBURSA: [ ON, OFF ]
#     USE_BURROW: [ ON, OFF ]
# strategy:
#   matrix:
#     cpp: [ clang++, /usr/local/opt/llvm/bin/clang++ ]  ##todo g++-10
#     os: [ macos-latest, macos-11.0, macos-10.15 ]
# strategy:
#   matrix:
#     cpp: [ /usr/local/opt/llvm/bin/clang++, ]
#     os: [ "windows-latest", "windows-2019", "windows-2016" ]

jobs:
  build-iroha-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        # cpp: [ clang++, /usr/local/opt/llvm/bin/clang++ ]  ##todo g++-10
        # os: [ macos-latest, macos-11.0, macos-10.15 ]
        USE_BURROW: [ -DUSE_BURROW=ON, -DUSE_BURROW=OFF ]
    steps:
      - 
        name: Homebrew
        run: brew install cmake ninja
      -
        name: Checkout
        uses: actions/checkout@v2
      -
        name: Cache vcpkg
        uses: actions/cache@v2
        with:
          path: $PWD/build-vcpkg
          key:          ${{ runner.os }}-vcpkg-${{ github.sha }}
          restore-keys: ${{ runner.os }}-vcpkg-
      - 
        name: Build Iroha vcpkg dependancies
        run: |
          ./vcpkg/build_iroha_deps.sh $PWD/build-vcpkg $PWD/vcpkg
      - 
        name: CMake configure
        run: cmake -B build -DCMAKE_TOOLCHAIN_FILE=$PWD/build-vcpkg/scripts/buildsystems/vcpkg.cmake
             ${{ matrix.USE_BURROW }} #-DCMAKE_VERBOSE_MAKEFILE=ON
      -
        name: CMake build
        run: cmake --build build #--config Debug
      -
        name: CTest
        run: |
          cd build
          ctest
